{#
  Sortable Table Component

  A reusable component for creating sortable tables based on MOJ Design System.

  Features:
  - Server-side sorting with URL-based navigation
  - Custom CSS classes for table, headers, cells, and links
  - Clickable links in table cells with dynamic placeholders
  - Accessibility compliance with aria-sort attributes

  Usage:
  {% from "components/sortableTable.njk" import sortableTable %}

  {{ sortableTable({
    id: "cases-table",
    caption: "New cases",
    classes: "custom-table-class",
    data: casesData,
    columns: [
      {
        key: "fullName",
        text: "Full Name",
        link: "/cases/{{caseReference}}/details",
        linkClasses: "govuk-link--no-visited-state",
        cellClasses: "custom-cell-class"
      },
      {
        key: "caseReference",
        text: "Case Reference",
        classes: "custom-header-class",
        cellClasses: "govuk-table__cell--numeric"
      },
      {
        key: "dateReceived",
        text: "Date Received",
        sortable: true,
        classes: "govuk-table__header--numeric",
        cellClasses: "govuk-table__cell--numeric"
      }
    ],
    sortBy: "dateReceived",
    sortOrder: "asc",
    basePath: "/cases/new"
  }) }}

  Options:
  - id: Table element ID
  - caption: Optional table caption
  - classes: CSS classes for the table element
  - data: Array of data objects
  - columns: Array of column definitions with:
    * key: Data property key
    * text: Column header text
    * sortable: Boolean for sortable columns
    * classes: CSS classes for header <th>
    * cellClasses: CSS classes for body <td>
    * link: URL pattern with placeholders ({{caseReference}}, {{fullName}}, {{id}})
    * linkClasses: CSS classes for links
    * linkKey: Custom property for {{id}} placeholder (defaults to 'id')
  - sortBy: Current sort column
  - sortOrder: Current sort order ('asc' or 'desc')
  - basePath: Base URL for sort links
#}

{% macro sortableTable(options) %}
  <table class="govuk-table{% if options.classes %} {{ options.classes }}{% endif %}" id="{{ options.id }}" data-module="moj-sortable-table">
    {% if options.caption %}
      <caption class="govuk-table__caption govuk-table__caption--m">{{ options.caption }}</caption>
    {% endif %}

    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        {% for column in options.columns %}
          {% if column.sortable %}
            {% set nextSortOrder = 'desc' if (options.sortBy == column.key and options.sortOrder == 'asc')
              else
                'asc' %}
            {% set sortUrl = options.basePath + '?sort=' + nextSortOrder %}
            <th scope="col" class="govuk-table__header{% if column.classes %} {{ column.classes }}{% endif %}" data-sort="{{ column.key }}" aria-sort="{% if options.sortBy == column.key %}{{ 'ascending' if options.sortOrder == 'asc' else 'descending' }}{% else %}none{% endif %}">
              <a href="{{ sortUrl }}" class="govuk-link govuk-link--no-visited-state{% if column.linkClasses %} {{ column.linkClasses }}{% endif %}">{{ column.text }}</a>
            </th>
          {% else %}
            <th scope="col" class="govuk-table__header{% if column.classes %} {{ column.classes }}{% endif %}">{{ column.text }}</th>
          {% endif %}
        {% endfor %}
      </tr>
    </thead>

    <tbody class="govuk-table__body">
      {% for row in options.data %}
        <tr class="govuk-table__row">
          {% for column in options.columns %}
            <td class="govuk-table__cell{% if column.cellClasses %} {{ column.cellClasses }}{% endif %}">
              {% if column.link %}
                {% set cellContent %}
                {% if column.key == "dateReceived" %}
                  {{ row[column.key] | formatDate }}
                {% elif column.key == "lastModified" %}
                  {{ row[column.key] | formatDate }}
                {% elif column.key == "dateClosed" %}
                  {{ row[column.key] | formatDate }}
                {% else %}
                  {% if row[column.key] %}
                    {{ row[column.key] }}
                  {% else %}
                    <span class="govuk-visually-hidden">No data</span>
                  {% endif %}
                {% endif %}
                {% endset %}
                {% set linkUrl = column
                  .link
                  .replace('{{id}}', row[column.linkKey or 'id'])
                  .replace('{{caseReference}}', row.caseReference)
                  .replace('{{fullName}}', row.fullName) %}
                <a href="{{ linkUrl }}" class="govuk-link{% if column.linkClasses %} {{ column.linkClasses }}{% endif %}">{{ cellContent | trim }}</a>
              {% else %}
                {% if column.key == "dateReceived" %}
                  {{ row[column.key] | formatDate }}
                {% elif column.key == "lastModified" %}
                  {{ row[column.key] | formatDate }}
                {% elif column.key == "dateClosed" %}
                  {{ row[column.key] | formatDate }}
                {% else %}
                  {% if row[column.key] %}
                    {{ row[column.key] }}
                  {% else %}
                    <span class="govuk-visually-hidden">No data</span>
                  {% endif %}
                {% endif %}
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}