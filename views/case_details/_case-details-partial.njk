{% from "govuk/components/character-count/macro.njk" import govukCharacterCount %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "components/errorSummaryComponent.njk" import errorSummary %}
{% from "govuk/components/table/macro.njk" import govukTable %}

<span class="case-details-tab-heading-alignment govuk-!-margin-bottom-4">
  <h2 class="govuk-heading-m">{{ t('pages.caseDetails.tabs.caseDetails') }}</h2>
  <a class="govuk-body govuk-link" href="#providerNote">{{ t('pages.caseDetails.caseDetailsSection.noteLabel') }}</a>
</span>
{% if error %}
  {{ errorSummary(error.errorSummaryList) }}
  {% set errorMessages = {
    providerNote: {
      text: error.inputErrors.providerNote
    }
    if error.inputErrors.providerNote
  } %}
{% endif %}
{# Client problem section #}
{% if data.scopeTraversal or data.client_notes %}
  <h3 class="govuk-heading-s">{{ t('pages.caseDetails.caseDetailsSection.clientProblemTitle') }}</h3>

  {% if data.scopeTraversal and data.scopeTraversal.category %}

    {% set rows = [] %}
    {% set label = t('pages.caseDetails.caseDetailsSection.category') | replace(":", "") | capitalize %}

    {# Category value #}

    {% set category = data.scopeTraversal.category %}

    {% set rows = rows.concat([
      [
        {
          text: label
        }, {
          text: category | string
        }
      ]
    ]) %}

    {# Onward Q&A rows #}

    {% set qas = data.scopeTraversal.onwardQuestion %}

    {% if qas %}
      {% for qa in qas %}
        {% set rows = rows.concat([
          [
            {
              text: qa.question | string
            }, {
              text: qa.answer | string
            }
          ]
        ]) %}
      {% endfor %}
    {% endif %}

    {{ govukTable({
    captionClasses: "govuk-table__caption--m",
    firstCellIsHeader: true,
    rows: rows
  }) }}

  {% endif %}

  {% if data.scopeTraversal %}
    <p class="govuk-hint govuk-!-margin-bottom-8">{{ data.scopeTraversal.created }}</p>
  {% endif %}

{% endif %}

{# Operator diagnosis section #}
{% if data.diagnosis %}
  <h3 class="govuk-heading-s">{{ t('pages.caseDetails.caseDetailsSection.operatorDiagnosisTitle') }}</h3>
  {% set rows = [] %}

  {% if data.diagnosis.diagnosisNode %}
    {% for node in data.diagnosis.diagnosisNode %}
      {% set rows = rows.concat([
        [
          {
            text: node.node
          }
        ]
      ]) %}
    {% endfor %}
  {% endif %}

  {{ govukTable({
    captionClasses: "govuk-table__caption--s",
    firstCellIsHeader: false,
    rows: rows
  }) }}

{% endif %}

{# Operator notes section #}
{% if data.operatorNotes %}
  <h3 class="govuk-heading-s">{{ t('pages.caseDetails.caseDetailsSection.operatorNotesTitle') }}</h3>
  <p class="govuk-body">{{ data.operatorNotes }}</p>
  <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-margin-bottom-6"/>
{% endif %}

{# Providers notes section #}
<h3 class="govuk-heading-s">{{ t('pages.caseDetails.caseDetailsSection.providerNotesTitle') }}</h3>
{% if data.notesHistory and data.notesHistory.length > 0 %}
  {% for note in data.notesHistory %}
    <div class="govuk-!-margin-bottom-4">
      <p class="govuk-body">{{ note.providerNotes }}</p>
      <p class="govuk-hint">{{ note.createdBy }} on {{ note.created }}</p>
      <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-margin-bottom-6"/>
    </div>
  {% endfor %}
{% else %}
  <p class="govuk-body">{{ t('pages.caseDetails.caseDetailsSection.noNotes') }}</p>
{% endif %}

{% block formContent %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

      <h3 class="govuk-heading-s govuk-!-margin-top-5">{{ t('pages.caseDetails.caseDetailsSection.noteLabel') }}</h3>

      <form method="post" action="">
        <input type="hidden" name="_csrf" value="{{ csrfToken }}">
        {{ govukCharacterCount({
        id: "providerNote",
        name: "providerNote",
        value: currentProviderNote,
        errorMessage: errorMessages.providerNote if error,
        maxlength: maxProviderNoteLength,
        threshold: characterThreshold
      }) }}

        {{ govukButton({
        text: t('common.save')
      }) }}
      </form>
    </div>
  </div>
{% endblock %}