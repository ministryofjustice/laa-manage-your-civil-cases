{% from "govuk/components/tag/macro.njk" import govukTag %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{%- from "moj/components/button-menu/macro.njk" import mojButtonMenu -%}
{%- from "moj/components/badge/macro.njk" import mojBadge -%}

{% set statusConfig = {
  "new": {
    text: t('common.status.new'),
    classes: "govuk-tag--green govuk-!-margin-bottom-2 tag-padding"
  },
  "pending": {
    text: t('common.status.pending'),
    classes: "govuk-tag--blue govuk-!-margin-bottom-2 tag-padding"
  },
  "advising": {
    text: t('common.status.advising'),
    classes: "govuk-tag--light-blue govuk-!-margin-bottom-2 tag-padding"
  },
  "closed": {
    text: t('common.status.closed'),
    classes: "govuk-tag--grey govuk-!-margin-bottom-2 tag-padding"
  },
  "completed": {
    text: t('common.status.completed'),
    classes: "govuk-tag--pink govuk-!-margin-bottom-2 tag-padding"
  }
} %}

{% set currentStatus = client.caseStatus %}

{# Case state change button logic #}
{% if currentStatus == "new" %}
  {% set menuItems = [
    {
      text: t('pages.caseDetails.buttons.actions.advising'),
      href: "/cases/" + client.caseReference + "/accept",
      attributes: {
        "data-method": "post"
      }
    }, {
      text: t('pages.caseDetails.buttons.actions.pending'),
      href: "/cases/" + client.caseReference + "/why-pending"
    }, {
      text: t('pages.caseDetails.buttons.actions.closed'),
      href: "/cases/" + client.caseReference + "/why-closed"
    }
  ] %}
{% elif currentStatus == "pending" %}
  {% set menuItems = [
    {
      text: t('pages.caseDetails.buttons.actions.advising'),
      href: "/cases/" + client.caseReference + "/accept",
      attributes: {
        "data-method": "post"
      }
    }, {
      text: t('pages.caseDetails.buttons.actions.closed'),
      href: "/cases/" + client.caseReference + "/why-closed"
    }
  ] %}
{% elif currentStatus == "advising" %}
  {# Empty hidden menu item to fix the issue: MOJ Button Menu component hides the dropdown when there's only one item #}
  {% set menuItems = [
    {
      text: t('pages.caseDetails.buttons.actions.completed'),
      href: "/cases/" + client.caseReference + "/completed",
      attributes: {
        "data-method": "post"
      }
    }, {
      text: '',
      classes: 'govuk-visually-hidden'
    }
  ] %}
{% elif currentStatus == "closed" %}
  {% set menuItems = [
    {
      text: t('pages.caseDetails.buttons.actions.advising'),
      href: "/cases/" + client.caseReference + "/why-reopen-closed-case"
    }, {
      text: '',
      classes: 'govuk-visually-hidden'
    }
  ] %}
{% elif currentStatus == "completed" %}
  {% set menuItems = [
    {
      text: t('pages.caseDetails.buttons.actions.advising'),
      href: "/cases/" + client.caseReference + "/why-reopen-completed-case"
    }, {
      text: '',
      classes: 'govuk-visually-hidden'
    }
  ] %}
{% endif %}

<div class="govuk-!-display-block">
  {# Name and case reference #}
  <p class="govuk-caption-l">{{ client.caseReference }}</p>
  <h1 class="govuk-heading-xl govuk-!-margin-bottom-6">{{ client.fullName }}</h1>

  {# Urgent case #}
  {% if client.is_urgent === 'true' %} 
    {{ mojBadge({
      text: t('pages.caseDetails.urgent'),
      classes: "moj-badge--red govuk-!-margin-bottom-3"
    }) }}
  {% endif %}

  {# Date received #}
  <h2 class="govuk-heading-s govuk-!-margin-bottom-1">{{ t('pages.caseDetails.dateReceived') }}: <span class="govuk-body">{{ client.provider_assigned_at | formatDate }}</span></h2>
  {# LAA reference #}
  <h2 class="govuk-heading-s govuk-!-margin-bottom-1">{{ t('pages.caseDetails.laaReference') }}: <span class="govuk-body">{{ client.laaReference }}</span></h2>

  <h2 class="govuk-heading-s govuk-!-margin-bottom-2">{{ t('pages.caseDetails.status') }}: 
    <span>
      {{ govukTag({
        text: statusConfig[currentStatus].text,
        classes: statusConfig[currentStatus].classes}) 
      }}
    </span>
  </h2>

  {% if hideStatusButton %}
    <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-margin-bottom-2"/>
  {% endif %}

  <div class="case-status-wrapper govuk-!-display-inline-block">
    {% if not hideStatusButton %}
      {{ mojButtonMenu({
          id: "change-case-status-menu",
          button: {
            text: t('pages.caseDetails.buttons.label'),
            classes: "govuk-!-margin-right-3"
          },
          preventDoubleClick: true,
          items: menuItems
      }) }}

      {{ govukButton({
        text: t('pages.caseDetails.buttons.splitThisCase'),
        href: "/cases/" + client.caseReference + "/split-this-case",
        classes: "govuk-button--secondary govuk-!-margin-right-3"
      }) }}

      {{ govukButton({
        text: t('pages.caseDetails.buttons.giveOperatorFeedback'),
        href: "/cases/" + client.caseReference + "/give-operator-feedback",
        classes: "govuk-button--secondary govuk-!-margin-right-3"
      }) }}
    {% endif %}
  </div>
</div>
