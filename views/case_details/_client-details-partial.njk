{% from "components/summaryCardComponent.njk" import summaryCardComponent %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% set phoneNumberContent %}
  {% if data.safeToCall %}
    {{ data.phoneNumber }}
    {% if not data.announceCall %}
      {{ govukWarningText({
        text: t('forms.clientDetails.phoneNumber.doNotAnnounce'),
        iconFallbackText: t.common.warning
      }) }}
    {% endif %}
  {% else %}
    {{ t('forms.clientDetails.phoneNumber.notSafeToCall') }}
  {% endif %}
{% endset %}

{% set phoneNumberContentThirdParty %}
  {% if data.thirdParty.safeToCall %}
    {{ data.thirdParty.contactNumber }}
  {% else %}
    {{ t('forms.clientDetails.thirdParty.notSafeToCall') }}
  {% endif %}
{% endset %}

{% set reasonableAdjustmentsContent %}
{% if data.reasonableAdjustments and data.reasonableAdjustments.selected and data.reasonableAdjustments.selected.length > 0 %}
  {{ data.reasonableAdjustments.selected | join('<br>') | safe }}
  {% if data.reasonableAdjustments.additionalInfo %}
    <br><br>{{ data.reasonableAdjustments.additionalInfo }}
  {% endif %}
{% endif %}
{% endset %}

{% macro renderAddress(address, postcode) %}
  {% if address %}
    {{ address }}
    {% if postcode %}
        <br>
    {% endif %}
  {% endif %}
  {% if postcode %}
    {{ postcode }}
  {% endif %}
{% endmacro %}

{% set addressWithPostcode = renderAddress(data.address, data.postcode) %}
{% set addressWithPostcodeThirdParty = renderAddress(data.thirdParty.address, data.thirdParty.postcode) %}

{% set passphraseContent %}
  {% if data.thirdParty.passphraseSetUp.selected[0] === "Yes" %}
    {{ data.thirdParty.passphraseSetUp.passphrase }}
  {% else %}
    {{ data.thirdParty.passphraseSetUp.selected[0] }}
  {% endif %}
{% endset %}

{% set relationshipToClient %}
  {% if data.thirdParty.relationshipToClient.selected %}
    {{ data.thirdParty.relationshipToClient.selected | join(', ') }}
  {% else %}
    ""
  {% endif %}
{% endset %}

{# Create enhanced data object with computed phone content #}
{% set constructedData = {
  fullName: data.fullName,
  dateOfBirth: data.dateOfBirth,
  email: data.emailAddress,
  phoneNumber: data.phoneNumber,
  specialNotes: data.specialNotes,
  reasonableAdjustments: data.reasonableAdjustments,
  computedReasonableAdjustments: reasonableAdjustmentsContent,
  language: data.language,
  address: data.address,
  postcode: data.postcode,
  computedPhoneNumber: phoneNumberContent,
  computedAddress: addressWithPostcode,
  fullNameThirdParty: data.thirdParty.fullName,
  computedAddressThirdParty: addressWithPostcodeThirdParty,
  computedPhoneNumberThirdParty: phoneNumberContentThirdParty,
  emailAddressThirdParty: data.thirdParty.emailAddress,
  relationshipToClientThirdParty: relationshipToClient,
  passphraseContent: passphraseContent
} %}

<h2 class="govuk-heading-m">{{ t.pages.caseDetails.clientDetails.heading }}</h2>
{# Client info summary card #}
{{ summaryCardComponent({
  data: constructedData,
  card: {
    title: {
      text: t('pages.caseDetails.clientDetails.aboutClient')
    }
  },
  rows: [
    {
      label: t('forms.clientDetails.name.label'),
      key: "fullName",
      actions: {
        items: [
          {
            href: "/cases/" + data.caseReference + "/client-details/change/name",
            text: t('common.change'),
            visuallyHiddenText: t('accessibility.visuallyHiddenText.changeName')
          }
        ]
      }
    },
    {
      label: t('forms.clientDetails.dateOfBirth.label'),
      key: "dateOfBirth",
      actions: {
        items: [
          {
            href: "/cases/" + data.caseReference + "/client-details/change/date-of-birth",
            text: t('common.change'),
            visuallyHiddenText: t('accessibility.visuallyHiddenText.changeDateOfBirth')
          }
        ]
      }
    }
  ]
}) }}
{# Contact Details summary card #}
{{ summaryCardComponent({
  data: constructedData,
  card: {
    title: {
      text: t('pages.caseDetails.clientDetails.contactDetails')
    }
  },
  rows: [
    {
      label: t('forms.clientDetails.reasonableAdjustments.label'),
      key: "computedReasonableAdjustments",
      html: true,
      actions: {
        items: [
          {
            href: "/",
            text: t('common.change'),
            visuallyHiddenText: t('accessibility.visuallyHiddenText.changeReasonableAdjustments')
          }
        ]
      }
    },
    {
      label: t('forms.clientDetails.language.label'),
      key: "language",
      actions: {
        items: [
          {
            href: "/",
            text: t('common.change'),
            visuallyHiddenText: t('accessibility.visuallyHiddenText.changeLanguage')
          }
        ]
      }
    },
    {
      label: t('forms.clientDetails.phoneNumber.label'),
      key: "computedPhoneNumber",
      html: true,
      actions: {
        items: [
          {
            href: "/cases/" + data.caseReference + "/client-details/change/phone-number",
            text: t('common.change'),
            visuallyHiddenText: t('accessibility.visuallyHiddenText.changePhoneNumber')
          }
        ]
      }
    },
    {
      label: t('forms.clientDetails.email.label'),
      key: "email",
      actions: {
        items: [
          {
            href: "/cases/" + data.caseReference + "/client-details/change/email-address",
            text: t('common.change'),
            visuallyHiddenText: t('accessibility.visuallyHiddenText.changeEmail')
          }
        ]
      }
    },
    {
      label: t('forms.clientDetails.address.label'),
      key: "computedAddress",
      html: true,
      actions: {
        items: [
          {
            href: "/cases/" + data.caseReference + "/client-details/change/address",
            text: t('common.change'),
            visuallyHiddenText: t('accessibility.visuallyHiddenText.changeAddress')
          }
        ]
      }
    }
  ]
}) }}

{% if data.thirdParty %}
  <h2 class="govuk-heading-m">{{ t('pages.caseDetails.clientDetails.thirdPartyContact') }}</h2>
  {# Third party info summary card #}
  {{ summaryCardComponent({
    data: constructedData,
    card: {
      title: {
        text: t('pages.caseDetails.clientDetails.thirdPartyContact')
      },
      actions: {
        items: [
          {
            href: "#",
            text: t('common.change'),
            visuallyHiddenText: t('accessibility.visuallyHiddenText.changeThirdPartyContact')
          },
          {
            href: "#",
            text: t('common.remove'),
            visuallyHiddenText: t('accessibility.visuallyHiddenText.removeThirdPartyContact')
          }
        ]
      }
    },
    rows: [
      {
        label: t('forms.clientDetails.thirdParty.name'),
        key: "fullNameThirdParty"
      },
      {
        label: t('forms.clientDetails.thirdParty.address'),
        key: "computedAddressThirdParty",
        html: true
      },
      {
        label: t('forms.clientDetails.thirdParty.contactNumber'),
        key: "computedPhoneNumberThirdParty",
        html: true
      },
      {
        label: t('forms.clientDetails.thirdParty.emailAddress'),
        key: "emailAddressThirdParty"
      },
      {
        label: t('forms.clientDetails.thirdParty.relationshipToClient'),
        key: "relationshipToClientThirdParty"
      },
      {
        label: t('forms.clientDetails.thirdParty.passphrase'),
        key: "passphraseContent",
        html: true
      }
    ]
  }) }}
{% else %}
  {{ govukButton({
    text: t('pages.caseDetails.buttons.addThirdPartyContact'),
    classes: "govuk-button--secondary"
  }) }}
{% endif %}